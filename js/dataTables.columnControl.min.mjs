import jQuery from"jquery";import DataTable from"datatables.net";let $=jQuery;import ColumnControl from"./ColumnControl";import{createElement}from"./util";function assetTarget(t,e,r){if(!t[e]){var n=!0,o=0,a=("number"==typeof e?o=e:("tfoot"===(a=e.split(":"))[0]&&(n=!1),a[1]&&(o=parseInt(a[1]))),n?r.table().header():r.table().footer());if(!a.querySelectorAll("tr")[o]){var i=r.columns().count(),l=createElement("tr");l.setAttribute("data-dt-order","disable");for(var c=0;c<i;c++)l.appendChild(createElement("td"));a.appendChild(l)}t[e]=!0}}function getOptionsForTarget(t,e){var r=ColumnControl.defaults.target;if(isIContentArray(e)){if(r===t)return{target:r,content:e}}else if(Array.isArray(e))for(var n=0;n<e.length;n++){var o=e[n];if(isIContentArray(o)){if(r===t)return{target:r,content:o}}else if(isIConfig(o)){if(t===(void 0!==o.target?o.target:r))return o}else if(t===r)return{target:r,content:e}}else if("object"==typeof e)if(isIConfig(e)){if(t===(void 0!==e.target?e.target:r))return e}else if(t===r)return{target:r,content:e}}function identifyTargets(e,t){function r(t){e.includes(t)||e.push(t)}return Array.isArray(t)?0===t.length?r(ColumnControl.defaults.target):t.forEach(function(t){r(("object"==typeof t&&void 0!==t.target?t:ColumnControl.defaults).target)}):"object"==typeof t&&r((void 0!==t.target?t:ColumnControl.defaults).target),e}function isIConfig(t){return"object"==typeof t&&void 0!==t.target}function isIContentArray(t){var e=!1;if(!Array.isArray(t))return!1;for(var r=0;r<t.length;r++)if(isIConfig(t[r])){e=!0;break}return!e}DataTable.ColumnControl=ColumnControl,$(document).on("i18n.dt",function(t,e){if("dt"===t.namespace){var r=new DataTable.Api(e),t=r.table().header(),n=e.oInit.columnControl,o=ColumnControl.defaults,a=[],i={};t.querySelectorAll("tr").length<=1&&null===e.titleRow&&(e.titleRow=0),identifyTargets(a,n),ColumnControl.defaults.content&&identifyTargets(a,o),r.columns().every(function(t){var e=this.init().columnControl;identifyTargets(a,e)});for(var l=0;l<a.length;l++)assetTarget(i,a[l],r)}}),$(document).on("preInit.dt",function(t,e){var l,c,u,s;"dt"===t.namespace&&(l=new DataTable.Api(e),c=e.oInit.columnControl,u=ColumnControl.defaults,identifyTargets(s=[],c),ColumnControl.defaults.content&&identifyTargets(s,u),l.columns().every(function(t){for(var e=this.init().columnControl,r=identifyTargets(s.slice(),e),n=0;n<r.length;n++){var o=getOptionsForTarget(r[n],e),a=getOptionsForTarget(r[n],c),i=getOptionsForTarget(r[n],u);(i||a||o)&&new ColumnControl(l,this.index(),Object.assign({},i||{},a||{},o||{}))}}))}),DataTable.Api.registerPlural("columns().ccSearchClear()","column().ccSearchClear()",function(){var r=this;return this.iterator("column",function(t,e){r.trigger("cc-search-clear",[e])})}),DataTable.ext.buttons.ccSearchClear={text:function(t){return t.i18n("columnControl.buttons.searchClear","Clear search")},init:function(r,t,e){var n=this;r.on("draw",function(){var t=!1,e=!!r.search();e||r.columns().every(function(){(this.search.fixed("dtcc")||this.search.fixed("dtcc-list"))&&(t=!0)}),n.enable(e||t)}),this.enable(!1)},action:function(t,e,r,n){e.search(""),e.columns().ccSearchClear(),e.draw()}};export default DataTable;